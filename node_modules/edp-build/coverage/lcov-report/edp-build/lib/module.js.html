<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for edp-build/lib/module.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../prettify.css">
    <link rel="stylesheet" href="../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">edp-build/lib/module.js</span></h1>
    <h2>
        Statements: <span class="metric">100% <small>(71 / 71)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">96.15% <small>(25 / 26)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">100% <small>(12 / 12)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">100% <small>(71 / 71)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">edp-build/lib/</a> &#187; module.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">559</span>
<span class="cline-any cline-yes">559</span>
<span class="cline-any cline-yes">559</span>
<span class="cline-any cline-yes">559</span>
<span class="cline-any cline-yes">559</span>
<span class="cline-any cline-yes">559</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">559</span>
<span class="cline-any cline-yes">559</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">551</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-yes">101</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">559</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">551</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">551</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-yes">41</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-yes">100</span>
<span class="cline-any cline-yes">142</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">551</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">551</span>
<span class="cline-any cline-yes">551</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">46</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">505</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">551</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">142</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">142</span>
<span class="cline-any cline-yes">207</span>
<span class="cline-any cline-yes">207</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">142</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">142</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">207</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">207</span>
<span class="cline-any cline-yes">141</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">66</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">66</span>
<span class="cline-any cline-yes">66</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">142</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">505</span>
<span class="cline-any cline-yes">505</span>
<span class="cline-any cline-yes">505</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">505</span>
<span class="cline-any cline-yes">505</span>
<span class="cline-any cline-yes">505</span>
<span class="cline-any cline-yes">463</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">42</span>
<span class="cline-any cline-yes">144</span>
<span class="cline-any cline-yes">33</span>
<span class="cline-any cline-yes">10</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">134</span>
<span class="cline-any cline-yes">102</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">42</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">46</span>
<span class="cline-any cline-yes">46</span>
<span class="cline-any cline-yes">46</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * Copyright (c) 2014 Baidu.com, Inc. All Rights Reserved
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * @file lib/module.js
 * @author leeight
 */
&nbsp;
var helper = require('./helper');
&nbsp;
/**
 * @constructor
 * @param {string} moduleId 模块的Id.
 * @param {CompilerContext} ctx 整个Compiler的上下文环境，提供必要的api和保存一些全局的数据.
 * @param {BundleConfig=} bundleConfig combine配置信息.
 */
function Module(moduleId, ctx, bundleConfig) {
    this.moduleId = moduleId;
    this.compilerContext = ctx;
    this.bundleConfig = bundleConfig || ctx.getBundleConfig(moduleId);
    this.definition = null;
    this.debug = require('debug')(moduleId);
    this.prepare();
}
&nbsp;
/**
 * 初始化 this.definition 的内容
 */
Module.prototype.prepare = function () {
    this.definition = this.compilerContext.getModuleDefinition(this.moduleId);
    if (!this.definition) {
        return;
    }
&nbsp;
    // File -&gt; [Mod 1, Mod 2, ..., Mod N]
    // Mod
    //   -&gt; Alias [Mod 1, Mod 2, ..., Mod N]
    //   -&gt; Deps  [Mod 1, Mod 2, ..., Mod N]
    //   -&gt; Includes [Mod 1, Mod 2, ..., Mod N]
    //   -&gt; Excludes [Mod 1, Mod 2, ..., Mod N]
    if (this.bundleConfig) {
        this.bundleConfig.addExclude(this.moduleId);
        var defs = this.definition.modDefs;
&nbsp;
        defs.forEach(function (def) {
            if (!def.id) {
                def.id = this.moduleId;
            }
&nbsp;
            // 因为这些模块已经包含在代码里面了，所以后续
            // 递归处理的时候，如果遇到了就不需要处理这些模块了
            this.bundleConfig.addExclude(def.id);
        }, this);
    }
};
&nbsp;
Module.prototype.toBundle = function () {
    if (!this.definition) {
        this.debug('No definition');
        return '';
    }
&nbsp;
    var codes = [];
&nbsp;
    if (this.bundleConfig) {
        // 如果需要合并的话，这里会往 codes 里面添加一些所依赖模块的代码.
        // this.defs 的 类型是 Array.&lt;Object&gt;
        // this.bundleConfig.getIncludes() 的类型是 Array.&lt;string&gt;
        // 为了可以调用 this._bundleSingleModule 的接口，我们把 getIncludes() 返回的
        // 内容包装成 this._bundleSingleModule 所需要的格式 { id: string, actualDependencies: [string] }
        var extraDefs = this.bundleConfig.getIncludes().map(function (id) {
            return {
                id: id,
                actualDependencies: [id]
            };
        });
        var defs = [].concat(this.definition.modDefs).concat(extraDefs);
        defs.forEach(function (def) {
            codes.push.apply(codes, this._bundleSingleModule(def));
        }, this);
    }
&nbsp;
    // 现在是当前模块的代码
    codes.push(this.compilerContext.generateCode(this.definition));
&nbsp;
    var pkgDef = this.definition.pkgDef;
    if (pkgDef) {
        // 当模块是一个package时，需要生成代理模块代码，原模块代码自动附加的id带有`main`
        // 否则，具名模块内部使用相对路径的require可能出错
        codes.push(this._getPackageMainDef(pkgDef));
    }
    else {
        codes.push.apply(codes, this._getAliasDef(this.moduleId));
    }
&nbsp;
    return codes.join('\n\n');
};
&nbsp;
/**
 * @param {Object} def 模块的定义信息（一个文件中可能有多个，这只是其中的一个）.
 * @return {Array.&lt;string&gt;}
 */
Module.prototype._bundleSingleModule = function (def) {
    var moduleId = def.id;
&nbsp;
    // 初始化当前模块的所有依赖模块信息
    // 剥离resource里的moduleId，以及对依赖的moduleId进行normalize
    // er -&gt; require('./util')
    // ./util -&gt; er/util
    var deps = (def.actualDependencies || <span class="branch-1 cbranch-no" title="branch not covered" >[])</span>.map(function (id) {
        var depId = helper.resolveModuleId(id.split('!')[0], moduleId);
        return depId;
    });
&nbsp;
    var codes = [];
&nbsp;
    deps.forEach(function (depId) {
        // 有了 moduleId 和 depId
        // 那么就可以从 this.compilerContext.moduleMapConfigs 来看看
        // 是不是 depId 已经被改成其它的名字了
        depId = this.compilerContext.getXXX(moduleId, depId);
&nbsp;
        if (this.bundleConfig.isExcluded(depId)) {
            return;
        }
&nbsp;
        this.bundleConfig.addExclude(depId);
&nbsp;
        // 这里创建 Module 实例的时候，传递了 this.bundleConfig 参数，主要是
        // 为了后续递归的时候保留 excludes 的信息.
        var module = new Module(depId, this.compilerContext, this.bundleConfig);
        codes.push(module.toBundle());
    }, this);
&nbsp;
    return codes;
};
&nbsp;
/**
 * 因为module.conf里面的配置导致模块存在别名，这是一个很正常的情况，但是
 * 对于build代码来说是很SB的情况
 *
 * {
 *   "paths": {
 *     "tpl": "common/tpl"
 *   }
 * }
 *
 * // src/common/main.js
 * define(function(require){
 *   require('tpl');
 *   require('./tpl');
 *   require('common/tpl');
 * });
 *
 * 那么当合并 common/main 的时候，需要合并两个文件
 *
 * 1. src/common/main.js
 * 2. src/common/tpl.js
 *
 * 代码里面需要出现3个module id的定义
 *
 * define('common/tpl', ...)
 * define('tpl', function(require){ return require('common/tpl'); });
 * define('common/main', ...)
 *
 * @private
 * @param {Object} def 模块的定义信息.
 * @return {string}
 */
Module.prototype._getAliasDef = function () {
    var util = require('util');
    var codes = [];
    var tpl = '\n/** d e f i n e */\ndefine(\'%s\', [\'%s\'], function (target) { return target; });';
&nbsp;
    var currentModuleId = this.moduleId;
    var moduleIdAliases = this.compilerContext.getModuleIdAlias(currentModuleId);
    if (!moduleIdAliases) {
        return;
    }
&nbsp;
    moduleIdAliases.forEach(function (moduleId) {
        if (this.bundleConfig) {
            if (this.bundleConfig.isExcluded(moduleId)) {
                return;
            }
            this.bundleConfig.addExclude(moduleId);
        }
        if (moduleId !== currentModuleId) {
            codes.push(util.format(tpl, moduleId, currentModuleId));
        }
    }, this);
&nbsp;
    return codes;
};
&nbsp;
/**
 * @private
 * @param {Object} pkgDef The package definition.
 * @return {string}
 */
Module.prototype._getPackageMainDef = function (pkgDef) {
    var id = pkgDef.name;
    var mod = pkgDef.module;
    return 'define(\'' + id + '\', [\'' + mod
        + '\'], function (main) { return main; });';
};
&nbsp;
module.exports = Module;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
/* vim: set ts=4 sw=4 sts=4 tw=120: */
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri May 15 2015 10:30:41 GMT+0800 (CST)</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
