<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for edp-build/lib/compiler-context.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../prettify.css">
    <link rel="stylesheet" href="../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">edp-build/lib/compiler-context.js</span></h1>
    <h2>
        Statements: <span class="metric">99.03% <small>(102 / 103)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">89.47% <small>(34 / 38)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">100% <small>(16 / 16)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">99.03% <small>(102 / 103)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">edp-build/lib/</a> &#187; compiler-context.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">529</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">493</span>
<span class="cline-any cline-yes">493</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">451</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">42</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">561</span>
<span class="cline-any cline-yes">561</span>
<span class="cline-any cline-yes">32</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">529</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">529</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">521</span>
<span class="cline-any cline-yes">521</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">521</span>
<span class="cline-any cline-yes">521</span>
<span class="cline-any cline-yes">505</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">521</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">521</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">490</span>
<span class="cline-any cline-yes">490</span>
<span class="cline-any cline-yes">43</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">447</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">521</span>
<span class="cline-any cline-yes">521</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">521</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">214</span>
<span class="cline-any cline-yes">101</span>
<span class="cline-any cline-yes">101</span>
<span class="cline-any cline-yes">77</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24</span>
<span class="cline-any cline-yes">24</span>
<span class="cline-any cline-yes">24</span>
<span class="cline-any cline-yes">42</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">200</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-yes">2024</span>
<span class="cline-any cline-yes">963</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1061</span>
<span class="cline-any cline-yes">1061</span>
<span class="cline-any cline-yes">1061</span>
<span class="cline-any cline-yes">1025</span>
<span class="cline-any cline-yes">1025</span>
<span class="cline-any cline-yes">138</span>
<span class="cline-any cline-yes">138</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">138</span>
<span class="cline-any cline-yes">138</span>
<span class="cline-any cline-yes">378</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">138</span>
<span class="cline-any cline-yes">138</span>
<span class="cline-any cline-yes">138</span>
<span class="cline-any cline-yes">138</span>
<span class="cline-any cline-yes">378</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">505</span>
<span class="cline-any cline-yes">505</span>
<span class="cline-any cline-yes">463</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">42</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">490</span>
<span class="cline-any cline-yes">490</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">551</span>
<span class="cline-any cline-yes">551</span>
<span class="cline-any cline-yes">551</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * Copyright (c) 2014 Baidu.com, Inc. All Rights Reserved
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * @file lib/compiler-context.js
 * @author leeight
 */
&nbsp;
var u = require('underscore');
var edp = require('edp-core');
var debug = require('debug')('compiler-context');
&nbsp;
var helper = require('./helper');
var BundleConfig = require('./bundle-config');
var ModuleDefinition = require('./module-definition');
var getPackageInfo = require('./util/get-package-info');
var generateModuleCode = require('./util/generate-module-code');
&nbsp;
/**
 * @constructor
 * @param {ProcessContext} pctx ProcessContext.
 * @param {string} moduleConfig module.conf的路径.
 * @param {Object} reader 读取模块源码的对象.
 * @param {Object} moduleCombineConfigs combine字段的内容.
 * @param {Object} moduleMapConfigs map字段的内容.
 */
function CompilerContext(pctx, moduleConfig, reader, moduleCombineConfigs, moduleMapConfigs) {
    this._pctx = pctx;
    this._moduleConfig = moduleConfig;
    this._reader = reader;
&nbsp;
    /**
     * 因为初始化 BundleConfig 的代价比较大，因此在这里记录一下已经初始化好的示例
     * 代价主要体现在需要多次扫描 AllModules
     *
     * 这个内容来自于 module.conf 的配置 或者 ModuleCompiler 的 getCombineConfig 的返回值
     * 因此不能直接从 `this._moduleConfig` 里面读取.
     *
     * @type {Object.&lt;string, BundleConfig&gt;}
     */
    this._moduleCombineConfigs = moduleCombineConfigs;
&nbsp;
    this._moduleMapConfigs = helper.createKVSortedIndex(moduleMapConfigs, 1);
    u.each(this._moduleMapConfigs, function (item) {
        item.v = helper.createKVSortedIndex(item.v);
    });
    debug('%j', this._moduleMapConfigs);
&nbsp;
    /**
     * 用来记录项目中所有的 Module Id 的信息.
     * @type {Array.&lt;string&gt;}
     */
    this._allModules = null;
&nbsp;
    /**
     * 二维数组.
     * @type {Array.&lt;Array.&lt;string&gt;&gt;}
     */
    this._aliasModules = [];
&nbsp;
    /**
     * key 是 module id
     * value 是 _aliasModules 的 index
     * @type {Object.&lt;string, number&gt;}
     */
    this._aliasModulesMap = {};
&nbsp;
    /**
     * 缓存模块的定义信息.
     * @type {Object.&lt;string, ModuleDefinition&gt;}
     */
    this._moduleDefinitions = {};
&nbsp;
    this.prepare();
}
&nbsp;
CompilerContext.prototype.prepare = function () {
    this._initAllModules();
};
&nbsp;
/**
 * @return {Object} 根据Module Id获取模块的内容，可以通过fs或者processContext中读取.
 */
CompilerContext.prototype.getReader = function () {
    return this._reader;
};
&nbsp;
/**
 * 如果这个模块在 module.conf 里面配置了 combine 的信息，那么
 * 通过这个接口就可以获取对应的 BundleConfig 的实例.
 *
 * @param {string} moduleId 模块的Id
 * @return {?BundleConfig}
 */
CompilerContext.prototype.getBundleConfig = function (moduleId) {
    var bundleConfig = this._moduleCombineConfigs[moduleId];
    if (!bundleConfig) {
        // 如果配置了 "x": false 或者 "x": 0 的情况，那么也就不要合并了.
        return null;
    }
&nbsp;
    return new BundleConfig(bundleConfig, this, moduleId);
};
&nbsp;
CompilerContext.prototype.getModuleDefinition = function (moduleId) {
    var definition = this._moduleDefinitions[moduleId];
    if (definition != null) {
        return definition;
    }
&nbsp;
    var code = this.getReader().readById(moduleId);
    // TODO Handle aliased module id
    if (!code) {
        return null;
    }
&nbsp;
    var ast = edp.amd.getAst(code);
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!ast) {
<span class="cstat-no" title="statement not covered" >        return null;</span>
    }
&nbsp;
    var defs = edp.amd.analyseModule(ast) || <span class="branch-1 cbranch-no" title="branch not covered" >[];</span>
    if (!Array.isArray(defs)) {
        defs = [defs];
    }
&nbsp;
    /**
     * 『包』的定义信息.
     * 从 module.conf 解析出来的 package 的配置信息
     * 并不是所有的模块都会有这个信息，例如：
     * 解析 dep/er/3.1.0-beta.6/src/main.js 的时候可以有这个配置信息，但是
     * 解析 dep/er/3.1.0-beta.6/src/ajax.js 的时候就没有了.
     */
    var pkgDef = null;
&nbsp;
    if (defs.length === 1 &amp;&amp; !defs[0].id) {
        // 说明这个文件只有一个匿名的模块.
        // 大部分时候都符合这个逻辑.
        // src/foo.js
        // define(function (require) { return {}; });
        pkgDef = this._getPackageDef(moduleId);
        if (pkgDef) {
            defs[0].id = pkgDef.module;
        }
        else {
            defs[0].id = moduleId;
        }
    }
    else if (defs.length &gt; 1) {
        // src/foo.js
        // define(function (require) { return {}; });
        // define('bar1', function (require) { return {}; });
        // define('bar2', function (require) { return {}; });
        //
        // 如果存在多个匿名的模块，说明是有问题的，对吧?
        // 这种情况比较少，先不处理了 (TODO)
&nbsp;
        // 如果全部都是具名的模块，那么合并的时候，这些id应该被排除掉的，对吧?
    }
&nbsp;
    definition = new ModuleDefinition(defs, pkgDef, ast);
    this._moduleDefinitions[moduleId] = definition;
&nbsp;
    return definition;
};
&nbsp;
/**
 * 根据 map 的配置，返回新的 depId（如果有的话），如果没有，返回
 * 参数中的 depId
 *
 * @param {string} moduleId 模块Id.
 * @param {string} depId 模块所依赖的模块Id.
 * @return {string}
 */
CompilerContext.prototype.getXXX = function (moduleId, depId) {
    for (var i = 0; i &lt; this._moduleMapConfigs.length; i++) {
        var item = this._moduleMapConfigs[i];
        if (!item.reg.test(moduleId)) {
            continue;
        }
&nbsp;
        var value = item.v;
        debug('value = %j', value);
        for (var j = 0; j &lt; value.length; j++) {
            if (value[j].reg.test(depId)) {
                return depId.replace(value[j].k, value[j].v);
            }
        }
    }
&nbsp;
    return depId;
};
&nbsp;
CompilerContext.prototype.getAllModules = function () {
    return this._allModules || <span class="branch-1 cbranch-no" title="branch not covered" >[];</span>
};
&nbsp;
/**
 * @private
 */
CompilerContext.prototype._initAllModules = function () {
    var allModules = [];
    var moduleConfig = this._moduleConfig;
&nbsp;
    Object.keys(this._pctx.files).forEach(function (file) {
        if (!/\.js$/.test(file)) {
            return;
        }
&nbsp;
        // abs不一定真正在磁盘上存在.
        var abs = edp.path.resolve(this._pctx.baseDir, file);
        var moduleIds = helper.getModuleId(abs, moduleConfig);
        if (moduleIds.length) {
            allModules.push.apply(allModules, moduleIds);
            if (moduleIds.length &gt; 1) {
                debug('%j = %j', file, moduleIds);
                this._addToAliasMap(moduleIds);
            }
        }
    }, this);
&nbsp;
    this._allModules = allModules;
};
&nbsp;
/**
 * 记录一下项目中重名的模块
 * [
 *   [],
 *   []
 * ],
 * {
 *   "id1": 0,
 *   "id2": 0
 * }
 * @param {Array.&lt;string&gt;} moduleIds 重名的模块数组列表.
 */
CompilerContext.prototype._addToAliasMap = function (moduleIds) {
    var found = false;
    moduleIds.forEach(function (moduleId) {
        found = found || (this._aliasModulesMap[moduleId] != null);
    }, this);
&nbsp;
    <span class="missing-if-branch" title="else path not taken" >E</span>if (!found) {
        this._aliasModules.push(moduleIds);
        var value = this._aliasModules.length - 1;
        moduleIds.forEach(function (moduleId) {
            this._aliasModulesMap[moduleId] = value;
        }, this);
    }
};
&nbsp;
/**
 * CompilerContext初始化的时候会遍历项目中所有的模块，同时记录下具有别名的模块信息
 * 后续输出代码的时候，如果需要输出别名，就调用这个函数查询一下.
 *
 * @param {string} moduleId 模块的Id.
 * @return {?Array.&lt;string&gt;} 模块的别名，如果没有的话，返回null.
 */
CompilerContext.prototype.getModuleIdAlias = function (moduleId) {
    var value = this._aliasModulesMap[moduleId];
    if (value == null) {
        return null;
    }
&nbsp;
    return this._aliasModules[value];
};
&nbsp;
/**
 * @private
 * @param {string} moduleId 模块的Id.
 * @return {?Object}
 */
CompilerContext.prototype._getPackageDef = function (moduleId) {
    var pkgDef = getPackageInfo(moduleId, this._moduleConfig);
    return pkgDef;
};
&nbsp;
/**
 * 根据 defs 和 ast 的信息生成最终的代码.
 * @param {ModuleDefinition} definition 模块的定义信息.
 * @return {string}
 */
CompilerContext.prototype.generateCode = function (definition) {
    var defs = definition.modDefs;
    var ast = definition.ast;
    return generateModuleCode(defs, ast);
};
&nbsp;
&nbsp;
module.exports = CompilerContext;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
/* vim: set ts=4 sw=4 sts=4 tw=120: */
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri May 15 2015 10:30:41 GMT+0800 (CST)</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
