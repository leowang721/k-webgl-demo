<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for edp-build/lib/processor/stylus-compiler.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../../prettify.css">
    <link rel="stylesheet" href="../../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">edp-build/lib/processor/stylus-compiler.js</span></h1>
    <h2>
        Statements: <span class="metric">80.49% <small>(33 / 41)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">57.14% <small>(8 / 14)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">77.78% <small>(7 / 9)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">80.49% <small>(33 / 41)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../index.html">All files</a> &#187; <a href="index.html">edp-build/lib/processor/</a> &#187; stylus-compiler.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * @file Stylus编译的构建处理器
 * @author errorrik[errorrik@gmail.com]
 *         junmer[junmer@foxmail.com]
 *         leeight[leeiht@gmail.com]
 */
var util = require('util');
var path = require('path');
&nbsp;
var u = require('underscore');
var stylus = require('stylus');
var edp = require('edp-core');
&nbsp;
var AbstractProcessor = require('./abstract');
var helper = require('./helper');
&nbsp;
/**
 * Stylus编译的构建处理器
 *
 * @constructor
 * @param {Object} options 初始化参数
 */
function StylusCompiler(options) {
    AbstractProcessor.call(this, options);
    // 兼容一下老的配置规则 entryExtnames
    this.entryFiles = this.entryFiles || <span class="branch-1 cbranch-no" title="branch not covered" >helper.ext2files(this.entryExtnames);</span>
}
util.inherits(StylusCompiler, AbstractProcessor);
&nbsp;
StylusCompiler.DEFAULT_OPTIONS = {
    name: 'StylusCompiler',
    entryFiles: [
        '*.html', '*.htm', '*.phtml',
        '*.tpl', '*.vm', '*.js'
    ],
    files: ['*.styl'],
    compileOptions: {}
};
&nbsp;
/**
 * 构建处理
 *
 * @param {FileInfo} file 文件信息对象
 * @param {ProcessContext} processContext 构建环境对象
 * @param {Function} callback 处理完成回调函数
 */
StylusCompiler.prototype.process = function (file, processContext, callback) {
    var compileOptions = this.compileOptions || <span class="branch-1 cbranch-no" title="branch not covered" >{};</span>
    var options = u.extend({
        paths: [path.dirname(file.fullPath)],
        pathname: file.fullPath,
        use: compileOptions
    }, compileOptions);
&nbsp;
    try {
        helper.compileStylus(this.stylus || stylus, file.data, options)
            .then(function (css) {
                file.setData(css);
                file.outputPath = file.outputPath.replace(/\.styl$/, '.css');
                processContext.addFileLink(file.path, file.outputPath);
            })
            .fail(<span class="fstat-no" title="function not covered" >function (err) {</span>
<span class="cstat-no" title="statement not covered" >                edp.log.fatal('Compile stylus failed, file = [%s], msg = [%s]',</span>
                    file.path, err.toString());
<span class="cstat-no" title="statement not covered" >                file.outputPath = null;</span>
            })
            .fin(callback);
    }
    catch (ex) {
<span class="cstat-no" title="statement not covered" >        edp.log.fatal('Compile stylus failed, file = [%s], msg = [%s]',</span>
            file.path, ex.toString());
<span class="cstat-no" title="statement not covered" >        file.outputPath = null;</span>
<span class="cstat-no" title="statement not covered" >        callback();</span>
    }
};
&nbsp;
/**
 * 构建处理后的行为，替换page和js里对stylus资源的引用
 *
 * @param {ProcessContext} processContext 构建环境对象
 */
StylusCompiler.prototype.afterAll = function (processContext) {
    var entryFiles = processContext.getFilesByPatterns(this.entryFiles);
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!Array.isArray(entryFiles)) {
<span class="cstat-no" title="statement not covered" >        return;</span>
    }
&nbsp;
    entryFiles.forEach(function (file) {
        var result = (file.extname === 'js')
                     ? <span class="branch-0 cbranch-no" title="branch not covered" >helper.replaceRequireResource(file.data, 'css', resourceReplacer)</span>
                     : helper.replaceTagAttribute(file.data, 'link', 'href', valueReplacer);
&nbsp;
        <span class="missing-if-branch" title="else path not taken" >E</span>if (result) {
            file.setData(result);
        }
    });
};
&nbsp;
<span class="fstat-no" title="function not covered" >function resourceReplacer(resourceId) {</span>
<span class="cstat-no" title="statement not covered" >    return resourceId.replace(/\.styl$/, '.css');</span>
}
&nbsp;
function valueReplacer(value) {
    return value.replace(/\.styl($|\?)/, function (match, q) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (q === '?') {
<span class="cstat-no" title="statement not covered" >            return '.css?';</span>
        }
&nbsp;
        return '.css';
    });
}
&nbsp;
&nbsp;
module.exports = exports = StylusCompiler;
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri May 15 2015 10:30:41 GMT+0800 (CST)</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
