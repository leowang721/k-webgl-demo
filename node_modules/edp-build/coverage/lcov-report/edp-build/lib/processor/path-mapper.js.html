<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for edp-build/lib/processor/path-mapper.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../../prettify.css">
    <link rel="stylesheet" href="../../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">edp-build/lib/processor/path-mapper.js</span></h1>
    <h2>
        Statements: <span class="metric">97.47% <small>(77 / 79)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">84.21% <small>(32 / 38)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">92.86% <small>(13 / 14)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">97.47% <small>(77 / 79)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../index.html">All files</a> &#187; <a href="index.html">edp-build/lib/processor/</a> &#187; path-mapper.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">488</span>
<span class="cline-any cline-yes">236</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">556</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">556</span>
<span class="cline-any cline-yes">68</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">488</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">32</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">228</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">228</span>
<span class="cline-any cline-yes">228</span>
<span class="cline-any cline-yes">228</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">228</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40</span>
<span class="cline-any cline-yes">40</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40</span>
<span class="cline-any cline-yes">40</span>
<span class="cline-any cline-yes">674</span>
<span class="cline-any cline-yes">674</span>
<span class="cline-any cline-yes">674</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">674</span>
<span class="cline-any cline-yes">338</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">336</span>
<span class="cline-any cline-yes">336</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">674</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">48</span>
<span class="cline-any cline-yes">48</span>
<span class="cline-any cline-yes">126</span>
<span class="cline-any cline-yes">126</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">96</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">126</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56</span>
<span class="cline-any cline-yes">56</span>
<span class="cline-any cline-yes">216</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">258</span>
<span class="cline-any cline-yes">258</span>
<span class="cline-any cline-yes">258</span>
<span class="cline-any cline-yes">246</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">60</span>
<span class="cline-any cline-yes">60</span>
<span class="cline-any cline-yes">60</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * @file 路径映射的构建处理器
 * @author errorrik[errorrik@gmail.com]
 *         leeight[leeight@gmail.com]
 */
var util = require('util');
&nbsp;
var edp = require('edp-core');
&nbsp;
var AbstractProcessor = require('./abstract');
var helper = require('./helper');
&nbsp;
/**
 * 路径映射的构建处理器
 *
 * @constructor
 * @param {Object} options 初始化参数
 */
function PathMapper(options) {
    AbstractProcessor.call(this, options);
&nbsp;
    <span class="missing-if-branch" title="else path not taken" >E</span>if (typeof this.mapper !== 'function') {
        var to = this.to;
        var from = new RegExp('(^|/)' + this.from + '(/|$)');
        this.mapper = function (value) {
            return value.replace(from, function (match, head, tail) {
                return (head === '/' ? head : '') + to + (tail === '/' ? tail : '');
            });
        };
    }
&nbsp;
    var mapper = this.mapper;
&nbsp;
    /**
     * 值替换函数
     *
     * @param {string} value 原始值
     * @return {string}
     */
    this.valueReplacer = function (value) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!value) {
<span class="cstat-no" title="statement not covered" >            return '';</span>
        }
&nbsp;
        if (!edp.path.isLocalPath(value)) {
            return value;
        }
&nbsp;
        return mapper(value);
    };
}
util.inherits(PathMapper, AbstractProcessor);
&nbsp;
var K_PAGE_FILES = ['*.html', '*.htm', '*.phtml', '*.tpl', '*.vm'];
&nbsp;
PathMapper.DEFAULT_OPTIONS = {
    name: 'PathMapper',
    files: ['**/*'],
    replacements: [
        {type: 'html', tag: 'link', attribute: 'href', files: K_PAGE_FILES},
        {type: 'html', tag: 'img', attribute: 'src', files: K_PAGE_FILES},
        {type: 'html', tag: 'script', attribute: 'src', files: K_PAGE_FILES},
        {type: 'html', tag: 'a', attribute: 'href', files: K_PAGE_FILES},
        {type: 'html', tag: 'embed', attribute: 'src', files: K_PAGE_FILES},
        {type: 'html', tag: 'param', attribute: 'value', files: K_PAGE_FILES,
            condition: function (tagSource) {
                return /\sname=['"]movie['"]/.test(tagSource);
            }
        },
        {replacer: 'module-config', files: K_PAGE_FILES.slice(0).concat(['*.js'])},
        {replacer: 'inline-css', files: K_PAGE_FILES},
        {replacer: 'css', files: ['*.css', '*.less']}
    ],
    from: 'src',
    to: 'asset'
};
&nbsp;
/**
 * 构建处理
 *
 * @param {FileInfo} file 文件信息对象
 * @param {ProcessContext} processContext 构建环境对象
 * @param {Function} callback 处理完成回调函数
 */
PathMapper.prototype.process = function (file, processContext, callback) {
    var valueReplacer = this.valueReplacer;
    // 替换文件路径
    <span class="missing-if-branch" title="else path not taken" >E</span>if (file.outputPath) {
        file.outputPath = valueReplacer(file.outputPath);
        file.outputPaths = file.outputPaths.map(<span class="fstat-no" title="function not covered" >function (outputPath) {</span>
<span class="cstat-no" title="statement not covered" >            return valueReplacer(outputPath);</span>
        });
    }
    callback();
};
&nbsp;
PathMapper.prototype.afterAll = function (processContext) {
    var builtinReplacers = this.replacers;
    var valueReplacer = this.valueReplacer;
&nbsp;
    // 替换对象进行处理，替换文件内容
    // replacement替换有两种模式：
    // 1. 指定了type，使用固定逻辑替换
    // 2. 指定replacer，使用内置的replacer函数替换
    //
    // 2的灵活性更强。
    //
    // 1现在仅支持html tag的attribute替换
    // 2现在仅支持`module-config`替换
    // 1和2现在都是内置逻辑，原因是希望build配置是纯json。未来可能开放。
    this.replacements.forEach(
        function (replacement) {
            var files = replacement.files;
            if (!files) {
                var extnames = replacement.extnames;
                <span class="missing-if-branch" title="else path not taken" >E</span>if (extnames) {
                    files = helper.ext2files(extnames);
                }
            }
&nbsp;
            var replaceFiles = processContext.getFilesByPatterns(files);
            replaceFiles.forEach(function (file) {
                var data = file.data;
                var type = replacement.type;
                var replacer = replacement.replacer;
&nbsp;
                if (replacer) {
                    data = builtinReplacers[replacer](
                        valueReplacer, data, file);
                }
                else {
                    <span class="missing-if-branch" title="else path not taken" >E</span>if (type === 'html') {
                        data = require('../util/replace-tag-attribute')(
                            data,
                            replacement.tag,
                            replacement.attribute,
                            valueReplacer,
                            replacement.condition
                       );
                    }
                }
&nbsp;
                file.setData(data);
            });
        }
   );
&nbsp;
};
&nbsp;
/**
 * 内置的替换方法
 *
 * @namespace
 */
PathMapper.prototype.replacers = {
    /**
     * 替换css中引用的资源路径.
     *
     * @param {function(string)} valueReplacer 值替换函数
     * @param {string} data 文件数据
     * @param {FileInfo} file 文件信息对象
     * @return {string}
     */
    'css': function (valueReplacer, data, file) {
        var pattern = /\burl\s*\((["']?)([^\)]+)\1\)/g;
        return data.replace(pattern, function (match, startQuote, url) {
            var newUrl = valueReplacer(url);
            if (edp.path.isLocalPath(newUrl)) {
                // 把路径归一化一下，例如
                // ././../../ui/img/../img/logo.gif =&gt; ../../ui/img/logo.gif
                newUrl = edp.path.normalize(newUrl);
            }
            return require('util').format('url(%s%s%s)',
                startQuote, newUrl, startQuote);
        });
    },
&nbsp;
    /**
     * 替换html代码中内联的css中的资源路径.
     *
     * @param {function(string)} valueReplacer 值替换函数
     * @param {string} data 文件数据
     * @param {FileInfo} file 文件信息对象
     * @return {string}
     */
    'inline-css': function (valueReplacer, data, file) {
        var chunks = data.split(/(&lt;\/?style[^&gt;]*&gt;)/i);
        for (var i = 0, l = chunks.length; i &lt; l; i++) {
            if (/^&lt;style\s+/i.test(chunks[i]) &amp;&amp; (i + 1) &lt; l) {
                // 如果遇到了'&lt;style '开头的内容，说明下面的部分是样式的代码了
                chunks[i + 1] = PathMapper.prototype.replacers.css(
                    valueReplacer, chunks[i + 1], file);
            }
        }
&nbsp;
        return chunks.join('');
    },
&nbsp;
    /**
     * 模块配置路径替换
     *
     * @param {function(string)} valueReplacer 值替换函数
     * @param {string} data 文件数据
     * @param {FileInfo} file 文件信息对象
     * @return {string}
     */
    'module-config': function (valueReplacer, data, file) {
        var readLoaderConfig = require('../util/read-loader-config');
        var confInfo = readLoaderConfig(data);
        if (!confInfo) {
            return data;
        }
&nbsp;
        var confData = confInfo.data;
&nbsp;
        if (confData.baseUrl) {
            confData.baseUrl = valueReplacer(confData.baseUrl);
        }
&nbsp;
        var paths = confData.paths || {};
        /*eslint-disable*/
        for (var key in paths) {
            paths[key] = valueReplacer(paths[key]);
        }
        /*eslint-enable*/
&nbsp;
        var packages = confData.packages || [];
        for (var i = 0; i &lt; packages.length; i++) {
            var pkg = packages[i];
            <span class="missing-if-branch" title="else path not taken" >E</span>if (typeof pkg === 'object' &amp;&amp; pkg.location) {
                pkg.location = valueReplacer(pkg.location);
            }
        }
&nbsp;
        var replaceLoaderConfig = require('../util/replace-loader-config');
        return replaceLoaderConfig(confData, confInfo);
    }
};
&nbsp;
module.exports = exports = PathMapper;
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri May 15 2015 10:30:41 GMT+0800 (CST)</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
